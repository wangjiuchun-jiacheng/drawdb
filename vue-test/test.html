<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DrawDB 微前端集成测试</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/qiankun@2.10.16/lib/umd/qiankun.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .app-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .app-header h1 {
      margin: 0;
      font-size: 24px;
    }
    .app-header p {
      margin: 8px 0 0 0;
      opacity: 0.9;
    }
    .app-content {
      padding: 20px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="app-container">
      <div class="app-header">
        <h1>🎨 DrawDB 微前端集成测试</h1>
        <p>将React的DrawDB集成到Vue应用中的完整示例</p>
      </div>
      <div class="app-content">
        <drawdb-editor></drawdb-editor>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    const { loadMicroApp, initGlobalState } = qiankun;

    // DrawDB Editor 组件
    const DrawDBEditor = {
      template: `
        <div class="drawdb-editor" :style="containerStyle">
          <div class="header">
            <h3>📊 DrawDB 数据建模工具</h3>
            <div class="controls">
              <button @click="loadMicroApp" :disabled="loading" :class="{ loading: loading }">
                {{ loading ? '加载中...' : (microApp ? '🔄 重新加载' : '▶️ 加载DrawDB') }}
              </button>
              <button @click="exportData" :disabled="!ready" title="导出当前图表数据">
                📥 导出数据
              </button>
              <button @click="importSampleData" :disabled="!ready" title="导入示例数据">
                📤 导入示例
              </button>
              <button @click="clearMessages" title="清空日志">
                🧹 清空日志
              </button>
            </div>
          </div>
          
          <div 
            ref="container" 
            class="drawdb-container"
            :id="containerId"
          >
            <div id="drawdb-root" style="width: 100%; height: 100%;"></div>
            <div v-if="!microApp" class="placeholder">
              <div class="placeholder-content">
                <div class="placeholder-icon">🎯</div>
                <h3>DrawDB 微前端应用</h3>
                <p>点击"加载DrawDB"按钮开始使用数据建模工具</p>
              </div>
            </div>
          </div>
          
          <!-- 状态显示 -->
          <div class="status-bar">
            <div class="status-item">
              <span class="label">🔗 状态:</span>
              <span :class="['status', statusClass]">{{ status }}</span>
            </div>
            <div class="status-item">
              <span class="label">📋 表数量:</span>
              <span class="value">{{ tableCount }}</span>
            </div>
            <div class="status-item">
              <span class="label">🔗 关系数量:</span>
              <span class="value">{{ relationshipCount }}</span>
            </div>
            <div class="status-item">
              <span class="label">⏱️ 最后更新:</span>
              <span class="value">{{ lastUpdate }}</span>
            </div>
          </div>
          
          <!-- 消息日志 -->
          <div class="message-log">
            <h4>📋 通信日志 ({{ messages.length }})</h4>
            <div class="log-content">
              <div 
                v-for="(msg, index) in messages" 
                :key="index" 
                :class="['log-item', msg.type]"
              >
                <span class="timestamp">{{ formatTime(msg.timestamp) }}</span>
                <span class="type-badge" :class="msg.type">{{ getTypeIcon(msg.type) }} {{ msg.type.toUpperCase() }}</span>
                <span class="content">{{ msg.content }}</span>
              </div>
              <div v-if="messages.length === 0" class="no-messages">
                暂无日志消息
              </div>
            </div>
          </div>
        </div>
      `,
      data() {
        return {
          microApp: null,
          loading: false,
          ready: false,
          status: '未加载',
          containerId: \`drawdb-\${Date.now()}\`,
          tableCount: 0,
          relationshipCount: 0,
          lastUpdate: '未更新',
          messages: [],
          globalState: null
        }
      },
      computed: {
        containerStyle() {
          return {
            width: '100%',
            height: '600px',
            border: '2px solid #e1e5e9',
            borderRadius: '8px',
            overflow: 'hidden',
            position: 'relative',
            background: '#fafbfc'
          }
        },
        statusClass() {
          switch (this.status) {
            case '已就绪': return 'ready';
            case '加载中': return 'loading';
            case '错误': return 'error';
            default: return 'idle';
          }
        }
      },
      mounted() {
        this.initGlobalState();
      },
      beforeUnmount() {
        if (this.microApp) {
          this.microApp.unmount();
        }
      },
      methods: {
        initGlobalState() {
          // 初始化全局状态
          this.globalState = initGlobalState({
            'drawdb-import': null,
            'drawdb-export-request': null,
            'drawdb-data-change': null,
            'drawdb-save': null,
            'drawdb-ready': null,
            'drawdb-error': null
          });
          
          // 监听状态变化
          this.globalState.onGlobalStateChange((value, prev) => {
            Object.keys(value).forEach(key => {
              if (value[key] !== prev[key] && value[key]) {
                this.handleMicroAppMessage(key, value[key]);
              }
            });
          });
          
          // 暴露到全局供子应用使用
          window.qiankunGlobalState = this.globalState;
          this.addMessage('system', '🔧 全局状态管理器初始化完成');
        },
        
        async loadMicroApp() {
          this.loading = true;
          this.status = '加载中';
          this.addMessage('system', '🚀 开始加载DrawDB微前端应用...');
          
          try {
            if (this.microApp) {
              await this.microApp.unmount();
              this.addMessage('system', '📤 已卸载旧的微前端应用');
            }
            
            this.microApp = loadMicroApp({
              name: 'drawdb-editor',
              entry: 'http://localhost:3001',
              container: \`#\${this.containerId}\`,
              props: {
                onSave: this.handleSave,
                onDataChange: this.handleDataChange,
                onError: this.handleError
              }
            });
            
            await this.microApp.mountPromise;
            this.addMessage('system', '✅ DrawDB微前端应用加载成功');
            
          } catch (error) {
            console.error('DrawDB加载失败:', error);
            this.status = '错误';
            this.addMessage('error', \`❌ 加载失败: \${error.message}\`);
          } finally {
            this.loading = false;
          }
        },
        
        handleMicroAppMessage(eventName, data) {
          console.log('收到子应用消息:', eventName, data);
          
          switch (eventName) {
            case 'drawdb-ready':
              this.status = '已就绪';
              this.ready = true;
              this.addMessage('micro', '🎉 DrawDB应用已就绪，可以开始使用');
              break;
              
            case 'drawdb-data-change':
              if (data.data && data.data.diagram) {
                const { tables = [], relationships = [] } = data.data.diagram;
                this.tableCount = tables.length;
                this.relationshipCount = relationships.length;
                this.lastUpdate = this.formatTime(Date.now());
                this.addMessage('micro', \`📊 数据更新 - 表: \${tables.length}, 关系: \${relationships.length}\`);
              }
              break;
              
            case 'drawdb-save':
              this.addMessage('micro', '💾 用户触发保存操作');
              break;
              
            case 'drawdb-export':
              if (data.data && data.data.diagram) {
                this.handleExportData(data.data.diagram);
              }
              break;
              
            case 'drawdb-error':
              this.addMessage('error', \`⚠️ 子应用错误: \${data.data?.message || '未知错误'}\`);
              break;
          }
        },
        
        exportData() {
          if (!this.ready) return;
          
          this.addMessage('vue', '📥 请求导出数据...');
          this.globalState.setGlobalState({
            'drawdb-export-request': {
              timestamp: Date.now(),
              source: 'vue'
            }
          });
        },
        
        handleExportData(diagramData) {
          console.log('导出的数据:', diagramData);
          this.addMessage('vue', '✅ 数据导出成功，开始下载文件');
          
          // 下载JSON文件
          const dataStr = JSON.stringify(diagramData, null, 2);
          const blob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = \`drawdb-export-\${Date.now()}.json\`;
          a.click();
          URL.revokeObjectURL(url);
        },
        
        importSampleData() {
          if (!this.ready) return;
          
          const sampleData = {
            tables: [
              {
                id: 'user-table',
                name: 'users',
                x: 100,
                y: 100,
                locked: false,
                fields: [
                  { id: 'user-id', name: 'id', type: 'INTEGER', primary: true, notNull: true, increment: true },
                  { id: 'user-name', name: 'name', type: 'VARCHAR(100)', notNull: true },
                  { id: 'user-email', name: 'email', type: 'VARCHAR(255)', unique: true },
                  { id: 'user-created', name: 'created_at', type: 'TIMESTAMP', default: 'CURRENT_TIMESTAMP' }
                ],
                comment: '用户表 - 存储用户基本信息'
              },
              {
                id: 'post-table',
                name: 'posts',
                x: 450,
                y: 100,
                locked: false,
                fields: [
                  { id: 'post-id', name: 'id', type: 'INTEGER', primary: true, notNull: true, increment: true },
                  { id: 'post-title', name: 'title', type: 'VARCHAR(200)', notNull: true },
                  { id: 'post-content', name: 'content', type: 'TEXT' },
                  { id: 'post-user-id', name: 'user_id', type: 'INTEGER', notNull: true },
                  { id: 'post-created', name: 'created_at', type: 'TIMESTAMP', default: 'CURRENT_TIMESTAMP' }
                ],
                comment: '文章表 - 存储用户发布的文章'
              }
            ],
            relationships: [
              {
                id: 0,
                name: 'fk_posts_user_id',
                startTableId: 'post-table',
                endTableId: 'user-table',
                startFieldId: 'post-user-id',
                endFieldId: 'user-id',
                cardinality: 'Many-to-One',
                updateConstraint: 'CASCADE',
                deleteConstraint: 'CASCADE'
              }
            ],
            database: 'MYSQL'
          };
          
          this.addMessage('vue', '📤 导入示例数据 (用户-文章表结构)...');
          this.globalState.setGlobalState({
            'drawdb-import': {
              diagram: sampleData,
              timestamp: Date.now(),
              source: 'vue'
            }
          });
        },
        
        addMessage(type, content) {
          this.messages.unshift({
            type,
            content,
            timestamp: Date.now()
          });
          
          // 限制日志数量
          if (this.messages.length > 100) {
            this.messages = this.messages.slice(0, 100);
          }
        },
        
        clearMessages() {
          this.messages = [];
          this.addMessage('system', '🧹 日志已清空');
        },
        
        formatTime(timestamp) {
          return new Date(timestamp).toLocaleTimeString('zh-CN');
        },
        
        getTypeIcon(type) {
          const icons = {
            system: '🔧',
            micro: '⚛️',
            vue: '💚',
            error: '❌'
          };
          return icons[type] || '📋';
        }
      }
    };

    // 创建Vue应用
    createApp({
      components: {
        DrawdbEditor: DrawDBEditor
      }
    }).mount('#app');
  </script>

  <style>
    .drawdb-editor {
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .header h3 {
      margin: 0;
      color: #495057;
      font-size: 18px;
    }

    .controls {
      display: flex;
      gap: 8px;
    }

    button {
      padding: 8px 16px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 500;
    }

    button:hover:not(:disabled) {
      background: #e9ecef;
      border-color: #adb5bd;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #f8f9fa;
    }

    button.loading {
      background: #e3f2fd;
      color: #1976d2;
      border-color: #bbdefb;
    }

    .drawdb-container {
      margin-bottom: 16px;
      position: relative;
    }

    .placeholder {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fafbfc;
    }

    .placeholder-content {
      text-align: center;
      color: #6c757d;
    }

    .placeholder-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .placeholder-content h3 {
      margin: 0 0 8px 0;
      font-size: 20px;
    }

    .placeholder-content p {
      margin: 0;
      font-size: 14px;
    }

    .status-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 8px;
      margin-bottom: 16px;
      border: 1px solid #dee2e6;
    }

    .status-item {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .label {
      font-weight: 600;
      color: #495057;
      font-size: 14px;
    }

    .status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status.idle { background: #e9ecef; color: #6c757d; }
    .status.loading { background: #e3f2fd; color: #1976d2; }
    .status.ready { background: #e8f5e8; color: #388e3c; }
    .status.error { background: #ffebee; color: #d32f2f; }

    .value {
      font-weight: 600;
      color: #212529;
      font-size: 14px;
    }

    .message-log {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background: white;
      overflow: hidden;
    }

    .message-log h4 {
      margin: 0;
      padding: 12px 16px;
      background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
      color: white;
      font-size: 16px;
      font-weight: 600;
    }

    .log-content {
      max-height: 300px;
      overflow-y: auto;
      padding: 8px;
    }

    .log-item {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      margin-bottom: 4px;
      border-radius: 6px;
      font-size: 13px;
      align-items: center;
      background: #f8f9fa;
      border-left: 3px solid transparent;
    }

    .log-item.system {
      border-left-color: #6c757d;
      background: #f8f9fa;
    }

    .log-item.micro {
      border-left-color: #20c997;
      background: #e8f5f0;
    }

    .log-item.vue {
      border-left-color: #4caf50;
      background: #e8f5e8;
    }

    .log-item.error {
      border-left-color: #dc3545;
      background: #ffebee;
    }

    .timestamp {
      color: #6c757d;
      min-width: 70px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .type-badge {
      min-width: 80px;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: bold;
      text-align: center;
      font-size: 11px;
      text-transform: uppercase;
    }

    .type-badge.system { background: #e9ecef; color: #495057; }
    .type-badge.micro { background: #d4edda; color: #155724; }
    .type-badge.vue { background: #d1ecf1; color: #0c5460; }
    .type-badge.error { background: #f8d7da; color: #721c24; }

    .content {
      flex: 1;
      color: #212529;
      line-height: 1.4;
    }

    .no-messages {
      text-align: center;
      color: #6c757d;
      padding: 20px;
      font-style: italic;
    }

    /* 滚动条样式 */
    .log-content::-webkit-scrollbar {
      width: 6px;
    }

    .log-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .log-content::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    .log-content::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</body>
</html>